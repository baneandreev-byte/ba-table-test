<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test tabela - Hidden Tag</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 16px; background: #f9fafb; margin: 0; }
    #status { padding: 8px 12px; border-radius: 6px; font-size: 12px; margin-bottom: 14px; background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; text-align: center; }
    #status.ready { background: #d1fae5; color: #065f46; border-color: #6ee7b7; }
    label { display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px; }
    select { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; color: #1f2937; background: #fff; margin-bottom: 14px; cursor: pointer; }
    .section { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: #fff; }
    .section-title { font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; }
    .hint { font-size: 11px; color: #6b7280; margin-bottom: 8px; line-height: 1.5; }
    button { display: block; width: 100%; padding: 10px; background: #1d4ed8; color: #fff; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; margin-bottom: 6px; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    button.secondary { background: #6b7280; }
    button.danger { background: #dc2626; }
    #log { margin-top: 12px; padding: 10px; background: #1f2937; color: #d1fae5; border-radius: 6px; font-family: monospace; font-size: 11px; min-height: 80px; white-space: pre-wrap; overflow-y: auto; max-height: 320px; }
    .err { color: #fca5a5; } .warn { color: #fde68a; } .ok { color: #6ee7b7; }
  </style>
</head>
<body>

<div id="status">‚è≥ Uƒçitavam Office...</div>

<label for="rowCount">Broj redova:</label>
<select id="rowCount" disabled>
  <option value="2">2</option><option value="3">3</option><option value="4">4</option>
  <option value="5" selected>5</option><option value="6">6</option>
  <option value="8">8</option><option value="10">10</option>
</select>

<div class="section">
  <div class="section-title">Generi≈°i / A≈æuriraj tabelu</div>
  <div class="hint">
    Ako tabela ne postoji ‚Üí kreira novu na kraju dokumenta.<br>
    Ako tabela veƒá postoji ‚Üí bri≈°e staru, ubacuje novu na istom mestu.<br>
    ID tag <b>[ID:BA_05]</b> je skriven (bela boja, font 1pt).
  </div>
  <button id="btnGenerate" disabled>Generi≈°i / A≈æuriraj tabelu</button>
</div>

<div class="section">
  <div class="section-title">Alati</div>
  <button id="btnClear" class="danger" disabled>Obri≈°i dokument</button>
  <button id="btnLogClear" class="secondary">Oƒçisti log</button>
</div>

<div id="log"></div>

<script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
<script>
  const TABLE_ID_TAG = "[ID:BA_05]";

  function log(msg, type) {
    const d = document.getElementById("log");
    const line = document.createElement("div");
    if (type) line.className = type;
    line.textContent = new Date().toLocaleTimeString() + "  " + msg;
    d.appendChild(line);
    d.scrollTop = d.scrollHeight;
  }

  function getN() { return parseInt(document.getElementById("rowCount").value, 10); }

  function makeData(n) {
    const rows = [];
    for (let i = 0; i < n; i++) {
      // ID tag ide u prvu ƒáeliju prvog reda ‚Äî samo jednom
      const col0 = i === 0 ? `${TABLE_ID_TAG} ${i}` : String(i);
      rows.push([col0, `Red ${i + 1}`, ""]);
    }
    return rows;
  }

  document.getElementById("btnGenerate").onclick = async () => {
    const n = getN();
    const data = makeData(n);
    log(`‚ñ∂ Generi≈°i/a≈æuriraj tabelu: ${n} redova...`);
    log(`   data[0]: [${data[0].map(v => `"${v}"`).join(", ")}]`);

    try {
      await Word.run(async (ctx) => {

        // 1. Tra≈æi da li tabela veƒá postoji
        const searchResults = ctx.document.body.search(TABLE_ID_TAG, { matchCase: true });
        searchResults.load("items");
        await ctx.sync();
        log(`  Search za "${TABLE_ID_TAG}": ${searchResults.items.length} rezultata`);

        let targetRange;

        if (searchResults.items.length > 0) {
          // Tabela postoji ‚Äî naƒëi je i obri≈°i
          log("  üîÑ Tabela postoji, a≈æuriram...");
          const foundRange = searchResults.items[0];
          const parentTable = foundRange.parentTable;
          parentTable.load("isNullObject");
          await ctx.sync();

          if (parentTable.isNullObject) {
            log("  ‚ö†Ô∏è parentTable je null ‚Äî ubacujem na kraj", "warn");
            targetRange = ctx.document.body.getRange(Word.RangeLocation.end);
          } else {
            // Uzmi range posle tabele, pa obri≈°i tabelu
            targetRange = parentTable.getRange(Word.RangeLocation.after);
            parentTable.delete();
            log("  Stara tabela obrisana");
          }

          await ctx.sync();

          // Ubaci novu tabelu pre tog range-a
          const newTable = targetRange.insertTable(n, 3, Word.InsertLocation.before, data);
          newTable.styleBuiltIn = Word.Style.tableGrid;
          await ctx.sync();
          log("  Nova tabela ubaƒçena");

          // Sakrij ID tag
          await hideTag(ctx, newTable);

        } else {
          // Tabela ne postoji ‚Äî kreiraj na kraju dokumenta
          log("  üÜï Tabela ne postoji, kreiram novu...");
          const newTable = ctx.document.body.insertTable(
            n, 3, Word.InsertLocation.end, data
          );
          newTable.styleBuiltIn = Word.Style.tableGrid;
          await ctx.sync();
          log("  Nova tabela ubaƒçena");

          // Sakrij ID tag
          await hideTag(ctx, newTable);
        }

        await ctx.sync();
        log(`‚úÖ Gotovo ‚Äî tabela ${n}√ó3`, "ok");
      });
    } catch (e) {
      log("‚ùå " + e.message, "err");
      log("   " + (e.stack || ""), "err");
    }
  };

  // Sakrij ID tag: bela boja + font 1pt
  async function hideTag(ctx, table) {
    const firstCellRange = table.getCell(0, 0).getRange();
    const tagSearch = firstCellRange.search(TABLE_ID_TAG, { matchCase: true });
    tagSearch.load("items");
    await ctx.sync();
    if (tagSearch.items.length > 0) {
      tagSearch.items[0].font.color = "white";
      tagSearch.items[0].font.size = 1;
      await ctx.sync();
      log("  ID tag sakriven (bela, 1pt)");
    } else {
      log("  ‚ö†Ô∏è ID tag nije naƒëen u prvoj ƒáeliji za skrivanje", "warn");
    }
  }

  document.getElementById("btnClear").onclick = async () => {
    try {
      await Word.run(async (ctx) => {
        ctx.document.body.clear();
        await ctx.sync();
        log("‚úÖ Dokument oƒçi≈°ƒáen", "ok");
      });
    } catch (e) { log("‚ùå " + e.message, "err"); }
  };

  document.getElementById("btnLogClear").onclick = () => {
    document.getElementById("log").innerHTML = "";
  };

  Office.onReady((info) => {
    log(`‚úÖ Office.onReady ‚Äî ${info.host} / ${info.platform}`, "ok");
    document.getElementById("status").textContent = `‚úÖ Spreman (${info.host} / ${info.platform})`;
    document.getElementById("status").className = "ready";
    ["rowCount","btnGenerate","btnClear"].forEach(id => {
      document.getElementById(id).disabled = false;
    });
  });
</script>
</body>
</html>
