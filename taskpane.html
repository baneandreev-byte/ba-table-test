<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test tabela - Bookmark</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 16px; background: #f9fafb; margin: 0; }
    #status {
      padding: 8px 12px; border-radius: 6px; font-size: 12px;
      margin-bottom: 14px; background: #fef3c7; color: #92400e;
      border: 1px solid #fbbf24; text-align: center;
    }
    #status.ready { background: #d1fae5; color: #065f46; border-color: #6ee7b7; }
    label { display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px; }
    select {
      width: 100%; padding: 8px 10px; border: 1px solid #d1d5db;
      border-radius: 6px; font-size: 13px; color: #1f2937;
      background: #fff; margin-bottom: 14px; cursor: pointer;
    }
    .section {
      border: 1px solid #e5e7eb; border-radius: 8px;
      padding: 12px; margin-bottom: 10px; background: #fff;
    }
    .section-title {
      font-size: 11px; font-weight: 700; color: #6b7280;
      text-transform: uppercase; margin-bottom: 8px;
    }
    .hint {
      font-size: 11px; color: #6b7280; margin-bottom: 8px; line-height: 1.5;
    }
    button {
      display: block; width: 100%; padding: 10px;
      background: #1d4ed8; color: #fff; border: none;
      border-radius: 6px; font-size: 12px; font-weight: 600;
      cursor: pointer; margin-bottom: 6px;
    }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    button.secondary { background: #6b7280; }
    button.danger { background: #dc2626; }
    #log {
      margin-top: 12px; padding: 10px; background: #1f2937; color: #d1fae5;
      border-radius: 6px; font-family: monospace; font-size: 11px;
      min-height: 80px; white-space: pre-wrap; overflow-y: auto; max-height: 300px;
    }
    .err  { color: #fca5a5; }
    .warn { color: #fde68a; }
    .ok   { color: #6ee7b7; }
  </style>
</head>
<body>

<div id="status">⏳ Učitavam Office...</div>

<label for="rowCount">Broj redova:</label>
<select id="rowCount" disabled>
  <option value="2">2 reda</option>
  <option value="3">3 reda</option>
  <option value="4">4 reda</option>
  <option value="5" selected>5 redova</option>
  <option value="6">6 redova</option>
  <option value="8">8 redova</option>
  <option value="10">10 redova</option>
</select>

<div class="section">
  <div class="section-title">Test 1 — Ubaci bookmark u dokument</div>
  <div class="hint">
    Ubacuje paragraf sa tekstom <b>BA_TABLE_05</b> i postavlja bookmark
    istog imena. Posle ovog testa vidiš placeholder u dokumentu.
  </div>
  <button id="btnInsertBookmark" disabled>Ubaci bookmark placeholder</button>
</div>

<div class="section">
  <div class="section-title">Test 2 — Nađi bookmark → zameni tabelom</div>
  <div class="hint">
    Traži bookmark <b>BA_TABLE_05</b>, uzima njegov range,
    i zamenjuje sa tabelom izabranog broja redova.
  </div>
  <button id="btnFillBookmark" disabled>Nađi bookmark → ubaci tabelu</button>
</div>

<div class="section">
  <div class="section-title">Alati</div>
  <button id="btnClear" class="danger" disabled>Obriši dokument</button>
  <button id="btnLogClear" class="secondary">Očisti log</button>
</div>

<div id="log"></div>

<script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
<script>
  function log(msg, type) {
    const d = document.getElementById("log");
    const line = document.createElement("div");
    if (type) line.className = type;
    line.textContent = new Date().toLocaleTimeString() + "  " + msg;
    d.appendChild(line);
    d.scrollTop = d.scrollHeight;
  }

  function getN() {
    return parseInt(document.getElementById("rowCount").value, 10);
  }

  function makeData(n) {
    const rows = [];
    for (let i = 0; i < n; i++) rows.push([String(i), `Red ${i + 1}`, ""]);
    return rows;
  }

  // -------------------------------------------------------
  // TEST 1: Ubaci bookmark placeholder u dokument
  // Simulira ono što bi korisnik postavio u template ručno
  // -------------------------------------------------------
  document.getElementById("btnInsertBookmark").onclick = async () => {
    log("▶ Test 1: ubacujem bookmark BA_TABLE_05...");
    try {
      await Word.run(async (ctx) => {
        // Ubaci paragraf sa placeholder tekstom
        const p = ctx.document.body.insertParagraph(
          "[ BA_TABLE_05 ]", Word.InsertLocation.end
        );
        await ctx.sync();
        log("  Paragraf ubačen");

        // Postavi bookmark na taj paragraf
        const range = p.getRange();
        range.insertBookmark("BA_TABLE_05");
        await ctx.sync();
        log("✅ Bookmark BA_TABLE_05 postavljen", "ok");
        log("  (u finalnom template-u korisnik ovo radi ručno: Insert → Bookmark)", "warn");
      });
    } catch (e) {
      log("❌ " + e.message, "err");
      log("   " + (e.stack || ""), "err");
    }
  };

  // -------------------------------------------------------
  // TEST 2: Nađi bookmark po imenu, zameni sa tabelom
  // Ovo je glavni mehanizam koji ide u produkcijski plugin
  // -------------------------------------------------------
  document.getElementById("btnFillBookmark").onclick = async () => {
    const n = getN();
    log(`▶ Test 2: tražim bookmark BA_TABLE_05, zamenjujem sa tabelom ${n}×3...`);
    try {
      await Word.run(async (ctx) => {

        // Korak 1: dohvati range bookmarksa
        const bmRange = ctx.document.getBookmarkRange("BA_TABLE_05");
        bmRange.load("text");
        await ctx.sync();
        log(`  Bookmark nađen, tekst: "${bmRange.text}"`);

        // Korak 2: zameni sadržaj range-a sa tabelom
        const table = bmRange.insertTable(
          n, 3, Word.InsertLocation.replace, makeData(n)
        );
        table.styleBuiltIn = Word.Style.tableGrid;
        await ctx.sync();
        log(`✅ OK — tabela ${n}×3 ubačena na mestu bookmarksa`, "ok");
      });
    } catch (e) {
      log("❌ " + e.message, "err");
      log("   " + (e.stack || ""), "err");
    }
  };

  // -------------------------------------------------------
  // Alati
  // -------------------------------------------------------
  document.getElementById("btnClear").onclick = async () => {
    log("▶ Brišem dokument...");
    try {
      await Word.run(async (ctx) => {
        ctx.document.body.clear();
        await ctx.sync();
        log("✅ Dokument očišćen", "ok");
      });
    } catch (e) { log("❌ " + e.message, "err"); }
  };

  document.getElementById("btnLogClear").onclick = () => {
    document.getElementById("log").innerHTML = "";
  };

  // -------------------------------------------------------
  // Office ready
  // -------------------------------------------------------
  Office.onReady((info) => {
    log(`✅ Office.onReady — ${info.host} / ${info.platform}`, "ok");
    document.getElementById("status").textContent = `✅ Spreman (${info.host} / ${info.platform})`;
    document.getElementById("status").className = "ready";
    ["rowCount", "btnInsertBookmark", "btnFillBookmark", "btnClear"].forEach(id => {
      document.getElementById(id).disabled = false;
    });
  });
</script>
</body>
</html>
