<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test tabela - CC Tag</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 16px; background: #f9fafb; margin: 0; }
    #status { padding: 8px 12px; border-radius: 6px; font-size: 12px; margin-bottom: 14px; background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; text-align: center; }
    #status.ready { background: #d1fae5; color: #065f46; border-color: #6ee7b7; }
    label { display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px; }
    select { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; color: #1f2937; background: #fff; margin-bottom: 14px; cursor: pointer; }
    .section { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: #fff; }
    .section-title { font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; }
    .hint { font-size: 11px; color: #6b7280; margin-bottom: 8px; line-height: 1.5; }
    button { display: block; width: 100%; padding: 10px; background: #1d4ed8; color: #fff; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; margin-bottom: 6px; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    button.secondary { background: #6b7280; }
    button.danger { background: #dc2626; }
    #log { margin-top: 12px; padding: 10px; background: #1f2937; color: #d1fae5; border-radius: 6px; font-family: monospace; font-size: 11px; min-height: 80px; white-space: pre-wrap; overflow-y: auto; max-height: 380px; }
    .err { color: #fca5a5; } .warn { color: #fde68a; } .ok { color: #6ee7b7; }
  </style>
</head>
<body>

<div id="status">‚è≥ Uƒçitavam Office...</div>

<label for="rowCount">Broj redova podataka:</label>
<select id="rowCount" disabled>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5" selected>5</option>
  <option value="6">6</option>
  <option value="8">8</option>
  <option value="10">10</option>
</select>

<div class="section">
  <div class="section-title">Korak 1 ‚Äî Postavi CC marker</div>
  <div class="hint">
    Klikni u dokument gde ≈æeli≈° tabelu, pa klikni dugme.<br>
    Ubacuje hidden, locked Content Control kao marker.<br>
    Ovo se radi jednom pri pripremi ≈°ablona.
  </div>
  <button type="button" id="btnInsertMarker" disabled>Ubaci CC marker (BA_04)</button>
</div>

<div class="section">
  <div class="section-title">Korak 2 ‚Äî Generi≈°i / A≈æuriraj tabelu</div>
  <div class="hint">
    Pronalazi CC marker, pa tabelu odmah ispod njega.<br>
    Ako tabela ne postoji ‚Äî kreira je sa zaglavljem.<br>
    Ako postoji ‚Äî a≈æurira broj redova i sadr≈æaj bez brisanja.
  </div>
  <button type="button" id="btnGenerate" disabled>Generi≈°i / A≈æuriraj tabelu</button>
</div>

<div class="section">
  <div class="section-title">Alati</div>
  <button type="button" id="btnInspect" class="secondary" disabled>Inspect ‚Äî prika≈æi CC markere</button>
  <button type="button" id="btnClear" class="danger" disabled>Obri≈°i dokument</button>
  <button type="button" id="btnLogClear" class="secondary">Oƒçisti log</button>
</div>

<div id="log"></div>

<script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
<script>

const CC_TAG     = "BA_04";
const CC_TAG_TBL = "BA_04_TBL";
const CC_TITLE   = "[BA:04]";
const CC_TITLE_TBL = "[BA:04:TBL]";
const HEADERS    = ["#", "Naziv", "Vrednost"];
const COLS       = HEADERS.length;

let officeReady = false;
const ACTION_BTNS = ["btnInsertMarker", "btnGenerate", "btnInspect", "btnClear"];

// ---- Log helper ----
function log(msg, type) {
  const d = document.getElementById("log");
  const line = document.createElement("div");
  if (type) line.className = type;
  line.textContent = new Date().toLocaleTimeString() + "  " + msg;
  d.appendChild(line);
  d.scrollTop = d.scrollHeight;
}

function getN() {
  return parseInt(document.getElementById("rowCount").value, 10);
}

// ---- Disable/enable buttons tokom async operacija ----
function setLoading(loading) {
  const disabled = loading || !officeReady;
  ACTION_BTNS.forEach(id => { document.getElementById(id).disabled = disabled; });
  document.getElementById("rowCount").disabled = disabled;
}

// ---- Generi≈°i test podatke ----
function makeData(n) {
  const rows = [];
  for (let i = 0; i < n; i++) {
    rows.push([`${i + 1}`, `Red ${i + 1}`, `Vrednost ${i + 1}`]);
  }
  return rows;
}

// ============================================
// KORAK 1: Ubaci CC marker na poziciju kursora
// ============================================
document.getElementById("btnInsertMarker").onclick = async () => {
  log("‚ñ∂ Ubacujem CC marker...");
  setLoading(true);
  try {
    await Word.run(async (ctx) => {

      const existing = ctx.document.contentControls.getByTag(CC_TAG);
      existing.load("items");
      await ctx.sync();

      if (existing.items.length > 0) {
        log("‚ö†Ô∏è CC marker veƒá postoji u dokumentu!", "warn");
        log("   Koristi direktno Korak 2 za a≈æuriranje tabele.", "warn");
        return;
      }

      const sel = ctx.document.getSelection();
      const cc = sel.insertContentControl();
      cc.tag = CC_TAG;
      cc.title = CC_TITLE;
      cc.appearance = Word.ContentControlAppearance.hidden;

      await ctx.sync();

      cc.cannotDelete = true;
      cc.cannotEdit = true;

      await ctx.sync();
      log(`‚úÖ CC marker ubaƒçen ‚Äî tag: "${CC_TAG}"`, "ok");
      log("   Hidden i locked. Sada klikni Generi≈°i.", "ok");
    });
  } catch (e) {
    log("‚ùå " + e.message, "err");
  } finally {
    setLoading(false);
  }
};

// ============================================
// KORAK 2: Generi≈°i / A≈æuriraj tabelu
// ============================================
document.getElementById("btnGenerate").onclick = async () => {
  const n = getN();
  const data = makeData(n);
  log(`‚ñ∂ Generi≈°i/a≈æuriraj tabelu (${n} redova podataka)...`);
  setLoading(true);

  try {
    await Word.run(async (ctx) => {

      // 1. Naƒëi anchor CC marker
      const ccs = ctx.document.contentControls.getByTag(CC_TAG);
      ccs.load("items");
      await ctx.sync();

      if (ccs.items.length === 0) {
        log("‚ùå CC marker nije naƒëen! Najpre ubaci marker (Korak 1).", "err");
        return;
      }

      const cc = ccs.items[0];
      log("  ‚úÖ CC anchor marker naƒëen", "ok");

      // 2. Naƒëi CC wrapper tabele (BA_04_TBL) ‚Äî pouzdanije od afterRange.tables
      const tblCCs = ctx.document.contentControls.getByTag(CC_TAG_TBL);
      tblCCs.load("items");
      await ctx.sync();

      if (tblCCs.items.length > 0) {
        // Tabela postoji ‚Äî a≈æuriraj bez brisanja
        log("  üîÑ A≈æuriram postojeƒáu tabelu...");
        const tblCC = tblCCs.items[0];
        const tables = tblCC.tables;
        tables.load("items");
        await ctx.sync();

        if (tables.items.length === 0) {
          log("‚ö†Ô∏è CC wrapper naƒëen ali tabela unutra nedostaje. Rekreiram...", "warn");
          tblCC.delete(false);
          await ctx.sync();
          await createTable(ctx, cc, data, n);
        } else {
          const tbl = tables.items[0];
          tbl.load("rowCount");
          await ctx.sync();
          log(`     Trenutno redova: ${tbl.rowCount} (uklj. zaglavlje), cilj: ${n + 1}`);
          await updateTable(ctx, tbl, data, n);
        }
      } else {
        // Tabela ne postoji ‚Äî kreiraj
        log("  üÜï Kreiram novu tabelu...");
        await createTable(ctx, cc, data, n);
      }

      await ctx.sync();
      log("‚úÖ Gotovo!", "ok");
    });

  } catch (e) {
    log("‚ùå " + e.message, "err");
    log("   " + (e.stack || ""), "err");
  } finally {
    setLoading(false);
  }
};

// ============================================
// CREATE tabele sa zaglavljem
// ============================================
async function createTable(ctx, anchorCC, data, n) {
  const allRows = [HEADERS, ...data];
  const insertRange = anchorCC.getRange(Word.RangeLocation.after);
  const newTable = insertRange.insertTable(n + 1, COLS, Word.InsertLocation.after, allRows);
  newTable.styleBuiltIn = Word.Style.tableGrid;

  await ctx.sync();

  // Stilizuj zaglavlje
  const headerRow = newTable.getRow(0);
  headerRow.shadingColor = "#1d4ed8";
  headerRow.font.color = "#ffffff";
  headerRow.font.bold = true;

  await ctx.sync();

  // Wrap tabele u CC ‚Äî jedini pouzdan naƒçin za pronala≈æenje pri sledeƒáem pozivu
  const tblCC = newTable.getRange().insertContentControl();
  tblCC.tag = CC_TAG_TBL;
  tblCC.title = CC_TITLE_TBL;
  tblCC.appearance = Word.ContentControlAppearance.hidden;
  tblCC.cannotDelete = true;

  await ctx.sync();
  log(`  ‚úÖ Tabela kreirana (zaglavlje + ${n} redova podataka)`, "ok");
}

// ============================================
// UPDATE tabele ‚Äî bez brisanja tabele
// ============================================
async function updateTable(ctx, table, data, targetDataRows) {
  const targetTotalRows = targetDataRows + 1; // +1 za zaglavlje (red 0)

  table.load("rowCount");
  await ctx.sync();
  const currentTotalRows = table.rowCount;

  // Uƒçitaj sve redove odjednom
  table.load("rows/items");
  await ctx.sync();

  // Uƒçitaj sve ƒáelije za data redove odjednom (red 0 = zaglavlje, preskaƒçemo)
  const dataRowsToFill = Math.min(currentTotalRows - 1, targetDataRows);
  for (let i = 1; i <= dataRowsToFill; i++) {
    table.rows.items[i].load("cells/items");
  }
  await ctx.sync();

  // A≈æuriraj sve ƒáelije ‚Äî jedan sync na kraju, bez sync u petlji
  for (let i = 1; i <= dataRowsToFill; i++) {
    const dataIdx = i - 1;
    for (let c = 0; c < COLS; c++) {
      const cell = table.rows.items[i].cells.items[c];
      if (!cell) continue;
      cell.body.clear();
      const val = data[dataIdx] && data[dataIdx][c] != null ? String(data[dataIdx][c]) : "";
      if (val) cell.body.insertText(val, Word.InsertLocation.start);
    }
  }
  await ctx.sync();
  log(`     A≈æurirano ${dataRowsToFill} postojeƒáih data redova`);

  // Dodaj redove ako treba vi≈°e ‚Äî batch poziv (jedan API poziv umesto petlje)
  if (targetTotalRows > currentTotalRows) {
    const toAdd = targetTotalRows - currentTotalRows;
    const newRowsData = [];
    for (let i = currentTotalRows - 1; i < targetDataRows; i++) {
      newRowsData.push(
        data[i] ? data[i].map(v => (v != null ? String(v) : "")) : Array(COLS).fill("")
      );
    }
    table.addRows(Word.InsertLocation.end, toAdd, newRowsData);
    await ctx.sync();
    log(`     Dodato ${toAdd} novih redova`, "ok");
  }

  // Obri≈°i vi≈°ak redova odozdo (nikad ne bri≈°i red 0 = zaglavlje)
  if (currentTotalRows > targetTotalRows) {
    table.load("rows/items");
    await ctx.sync();
    for (let i = currentTotalRows - 1; i >= targetTotalRows; i--) {
      if (table.rows.items[i]) table.rows.items[i].delete();
    }
    await ctx.sync();
    log(`     Obrisano ${currentTotalRows - targetTotalRows} vi≈°ka redova`, "ok");
  }

  log(`     ‚úÖ Tabela a≈æurirana ‚Üí ${targetDataRows} redova podataka`, "ok");
}

// ============================================
// INSPECT
// ============================================
document.getElementById("btnInspect").onclick = async () => {
  log("‚ñ∂ Inspect...");
  setLoading(true);
  try {
    await Word.run(async (ctx) => {
      const ccs = ctx.document.contentControls;
      ccs.load("items/tag,items/title,items/appearance,items/cannotDelete");
      await ctx.sync();

      log(`  Ukupno CC u dokumentu: ${ccs.items.length}`);
      ccs.items.forEach((cc, i) => {
        log(`  [${i}] tag="${cc.tag}" title="${cc.title}" appearance="${cc.appearance}" cannotDelete=${cc.cannotDelete}`);
      });

      // Batch load oba taga u jednom sync-u
      const ba    = ctx.document.contentControls.getByTag(CC_TAG);
      const baTbl = ctx.document.contentControls.getByTag(CC_TAG_TBL);
      ba.load("items");
      baTbl.load("items");
      await ctx.sync();

      log(`  Anchor CC "${CC_TAG}": ${ba.items.length}`, ba.items.length > 0 ? "ok" : "warn");
      log(`  Table CC "${CC_TAG_TBL}": ${baTbl.items.length}`, baTbl.items.length > 0 ? "ok" : "warn");
    });
  } catch (e) {
    log("‚ùå " + e.message, "err");
  } finally {
    setLoading(false);
  }
};

// ============================================
// CLEAR
// ============================================
document.getElementById("btnClear").onclick = async () => {
  setLoading(true);
  try {
    await Word.run(async (ctx) => {
      ctx.document.body.clear();
      await ctx.sync();
      log("‚úÖ Dokument oƒçi≈°ƒáen", "ok");
    });
  } catch (e) {
    log("‚ùå " + e.message, "err");
  } finally {
    setLoading(false);
  }
};

document.getElementById("btnLogClear").onclick = () => {
  document.getElementById("log").innerHTML = "";
};

// ============================================
// INIT
// ============================================
Office.onReady((info) => {
  log(`‚úÖ Office.onReady ‚Äî ${info.host} / ${info.platform}`, "ok");
  document.getElementById("status").textContent = `‚úÖ Spreman (${info.host})`;
  document.getElementById("status").className = "ready";
  officeReady = true;
  setLoading(false);
});

</script>
</body>
</html>
